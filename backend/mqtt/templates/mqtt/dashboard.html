{% extends 'mqtt/base.html' %}

{% block title %}MQTT Dashboard - Overview{% endblock %}

{% block content %}
<div class="row">
    <!-- Statistics Cards -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted">Connections</h6>
                        <h4 class="mb-0">{{ active_connections }}/{{ total_connections }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-network-wired fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted">Sensors Online</h6>
                        <h4 class="mb-0">{{ online_sensors }}/{{ total_sensors }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-sensor fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted">Sensors Offline</h6>
                        <h4 class="mb-0">{{ offline_sensors }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted">Connection Errors</h6>
                        <h4 class="mb-0">{{ error_connections }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto Refresh Controls -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h5>MQTT Connections</h5>
            <div>
                <button id="refresh-btn" class="btn btn-outline-primary">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <div class="form-check form-switch d-inline-block ms-3">
                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                    <label class="form-check-label" for="auto-refresh">
                        Auto Refresh (10s)
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connections Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Site Connections</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="connections-table">
                        <thead>
                            <tr>
                                <th>Site</th>
                                <th>Code</th>
                                <th>Broker</th>
                                <th>Status</th>
                                <th>Last Connected</th>
                                <th>Last Heartbeat</th>
                                <th>Sensors</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for connection in connections %}
                            <tr data-site-id="{{ connection.site.id }}">
                                <td>
                                    <a href="{% url 'mqtt:site_detail' connection.site.id %}" class="text-decoration-none">
                                        {{ connection.site.name }}
                                    </a>
                                </td>
                                <td><code>{{ connection.site.code }}</code></td>
                                <td>{{ connection.broker_host }}:{{ connection.broker_port }}</td>
                                <td>
                                    <span class="badge bg-{% if connection.status == 'connected' %}success{% elif connection.status == 'connecting' %}warning{% elif connection.status == 'error' %}danger{% else %}secondary{% endif %}">
                                        {{ connection.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if connection.last_connected_at %}
                                        {{ connection.last_connected_at|date:"M d, H:i" }}
                                    {% else %}
                                        <span class="text-muted">Never</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if connection.last_heartbeat_at %}
                                        {{ connection.last_heartbeat_at|date:"M d, H:i" }}
                                    {% else %}
                                        <span class="text-muted">No data</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-success">{{ connection.online_sensor_count }}</span>
                                    /
                                    <span class="text-muted">{{ connection.sensor_count }}</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if connection.status != 'connected' %}
                                        <button class="btn btn-outline-success control-btn" data-action="start" data-site-id="{{ connection.site.id }}">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        {% endif %}
                                        {% if connection.status == 'connected' %}
                                        <button class="btn btn-outline-danger control-btn" data-action="stop" data-site-id="{{ connection.site.id }}">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-warning control-btn" data-action="restart" data-site-id="{{ connection.site.id }}">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted">No MQTT connections configured</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Logs -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Recent Connection Logs</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Site</th>
                                <th>Event</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in recent_logs %}
                            <tr>
                                <td>{{ log.timestamp|date:"M d, H:i:s" }}</td>
                                <td>{{ log.mqtt_connection.site.name }}</td>
                                <td>
                                    <span class="badge bg-{% if log.event_type == 'connected' %}success{% elif log.event_type == 'disconnected' %}warning{% elif log.event_type == 'error' %}danger{% else %}info{% endif %}">
                                        {{ log.get_event_type_display }}
                                    </span>
                                </td>
                                <td>{{ log.message|truncatechars:80 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No logs available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let autoRefreshInterval;

    // Auto refresh function
    function refreshData() {
        $.get('{% url "mqtt:api_status" %}')
            .done(function(data) {
                updateConnectionsTable(data.connections);
                console.log('Data refreshed at:', data.timestamp);
            })
            .fail(function() {
                console.error('Failed to refresh data');
            });
    }

    // Update connections table
    function updateConnectionsTable(connections) {
        const tbody = $('#connections-table tbody');

        connections.forEach(function(conn) {
            const row = $(`tr[data-site-id="${conn.id}"]`);
            if (row.length) {
                // Update status badge
                const statusBadge = row.find('td:nth-child(4) .badge');
                statusBadge.removeClass('bg-success bg-warning bg-danger bg-secondary');

                let statusClass = 'bg-secondary';
                if (conn.status === 'connected') statusClass = 'bg-success';
                else if (conn.status === 'connecting') statusClass = 'bg-warning';
                else if (conn.status === 'error') statusClass = 'bg-danger';

                statusBadge.addClass(statusClass).text(conn.status);
            }
        });
    }

    // Control buttons
    $('.control-btn').click(function() {
        const button = $(this);
        const action = button.data('action');
        const siteId = button.data('site-id');
        const originalHtml = button.html();

        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

        $.post(`/api/v1/mqtt/connection/${siteId}/control/`, {
            action: action,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        })
        .done(function(response) {
            if (response.success) {
                // Refresh data after successful action
                refreshData();
                // Show success message
                showAlert('success', response.message);
            } else {
                showAlert('danger', response.error);
            }
        })
        .fail(function() {
            showAlert('danger', 'Failed to execute action');
        })
        .always(function() {
            button.prop('disabled', false).html(originalHtml);
        });
    });

    // Manual refresh
    $('#refresh-btn').click(function() {
        refreshData();
    });

    // Auto refresh toggle
    $('#auto-refresh').change(function() {
        if ($(this).is(':checked')) {
            autoRefreshInterval = setInterval(refreshData, 10000);
        } else {
            clearInterval(autoRefreshInterval);
        }
    });

    // Start auto refresh
    autoRefreshInterval = setInterval(refreshData, 10000);

    // Alert helper
    function showAlert(type, message) {
        const alert = $(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);

        $('.container').prepend(alert);

        setTimeout(function() {
            alert.alert('close');
        }, 5000);
    }
});
</script>

<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}